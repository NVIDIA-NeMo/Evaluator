#!/bin/bash
# SPDX-FileCopyrightText: Copyright (c) 2025, NVIDIA CORPORATION. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# Built-in Ray cluster setup script for multi-node vLLM deployments.
#
# Detects single-instance vs multi-instance mode via NUM_INSTANCES (baked by Jinja):
#   - Single-instance (NUM_INSTANCES == 1): uses SLURM_PROCID for head/worker
#   - Multi-instance (NUM_INSTANCES > 1): computes INSTANCE_RANK from SLURM_PROCID
#
# Head node: starts Ray head, polls until all nodes join, then exits (lets deployment.command run vLLM)
# Worker node: starts Ray worker with --block (blocks forever, never reaches deployment.command)

set -euo pipefail

RAY_PORT=6379
NODE_PORT=8266
OBJ_PORT=8267
RAY_FIXED_PORTS="--node-manager-port=$NODE_PORT --object-manager-port=$OBJ_PORT --metrics-export-port=8269 --dashboard-agent-grpc-port=8270 --dashboard-agent-listen-port=8271 --runtime-env-agent-port=8272"

NODES_PER_INSTANCE={{ num_nodes_per_instance }}
NUM_INSTANCES={{ num_instances }}

# Determine mode: multi-instance (NUM_INSTANCES > 1) or single-instance
if [ "$NUM_INSTANCES" -gt 1 ]; then
    # Multi-instance mode: compute per-task instance vars from SLURM_PROCID
    export INSTANCE_ID=$((SLURM_PROCID / NODES_PER_INSTANCE))
    export INSTANCE_RANK=$((SLURM_PROCID % NODES_PER_INSTANCE))
    IFS="," read -ra _all_ips <<< "$ALL_NODE_IPS"
    export INSTANCE_MASTER_IP="${_all_ips[$((INSTANCE_ID * NODES_PER_INSTANCE))]}"
    export MASTER_IP="$INSTANCE_MASTER_IP"
    RANK="${INSTANCE_RANK}"
    EXPECTED_NODES="${NODES_PER_INSTANCE}"
    echo "=== Multi-Instance Ray Setup ==="
    echo "INSTANCE_ID=${INSTANCE_ID}, INSTANCE_RANK=${INSTANCE_RANK}, MASTER_IP=${MASTER_IP}"
    echo "NODES_PER_INSTANCE=${NODES_PER_INSTANCE}, NUM_INSTANCES=${NUM_INSTANCES}"
else
    # Single-instance mode: use SLURM_PROCID
    RANK="${SLURM_PROCID}"
    EXPECTED_NODES="${SLURM_NTASKS}"
    echo "=== Single-Instance Ray Setup ==="
    echo "SLURM_PROCID=${SLURM_PROCID}, MASTER_IP=${MASTER_IP}"
    echo "SLURM_NTASKS=${SLURM_NTASKS}"
fi
echo "Hostname: $(hostname)"

if [ "$RANK" -eq 0 ]; then
    # HEAD node
    export VLLM_HOST_IP=$MASTER_IP
    echo "Starting Ray HEAD on $(hostname) with VLLM_HOST_IP=$VLLM_HOST_IP"
    ray start --head --port=$RAY_PORT $RAY_FIXED_PORTS

    export RAY_ADDRESS=$MASTER_IP:$RAY_PORT
    echo "RAY_ADDRESS=$RAY_ADDRESS â€” waiting for $EXPECTED_NODES node(s) to join..."

    until [ "$(ray status 2>/dev/null | grep -c 'node_')" -ge "$EXPECTED_NODES" ]; do
        sleep 10
    done

    echo "=== Ray cluster ready ==="
    ray status

    # Run the deployment command (injected by the launcher)
    {{ deployment_command }}
else
    # WORKER node
    export VLLM_HOST_IP=$(python3 -c "import socket; s=socket.socket(socket.AF_INET, socket.SOCK_DGRAM); s.connect(('8.8.8.8', 80)); print(s.getsockname()[0])")
    echo "Starting Ray WORKER on $(hostname) with VLLM_HOST_IP=$VLLM_HOST_IP"
    echo "Connecting to Ray head at $MASTER_IP:$RAY_PORT..."

    # Retry loop in case head is still starting
    until ray start --address=$MASTER_IP:$RAY_PORT $RAY_FIXED_PORTS --block 2>/dev/null; do
        echo "Retrying connection to Ray head at $MASTER_IP:$RAY_PORT..."
        sleep 5
    done
fi
